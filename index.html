<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Cita</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            place-items: center;
            min-height: 100vh;
            padding: 2rem 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 550px;
            width: 90%;
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }
        .paso {
            text-align: left;
            margin-top: 1.5rem;
        }
        .paso > label {
            font-weight: bold;
            font-size: 1.2rem;
            display: block;
            margin-bottom: 0.75rem;
            color: #333;
        }
        
        input[type="date"],
        input[type="text"],
        input[type="tel"],
        input[type="email"] {
            font-size: 1.1rem;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="date"] { cursor: pointer; }

        .campo-texto { margin-bottom: 1rem; }
        .campo-texto label {
            font-weight: 600;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
            color: #555;
        }

        #contenedorHoras,
        #contenedorPersonas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .boton-hora,
        .boton-persona {
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 0.25rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .boton-hora:hover:not(:disabled),
        .boton-persona:hover {
            background-color: #eee;
            border-color: #ccc;
        }
        .boton-hora.selected,
        .boton-persona.selected {
            background-color: #0056b3;
            color: white;
            border-color: #004494;
        }
        
        /* ESTADO: 100% Lleno (Gris) */
        .boton-hora:disabled {
            background-color: #f1f1f1;
            color: #aaa;
            border-color: #eee;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* --- CAMBIO: Nuevo estilo para "No hay sitio suficiente" (Rojo) --- */
        .boton-hora.no-suficiente {
            background-color: #fff0f0; /* Fondo rojo pálido */
            color: #dc3545; /* Texto rojo oscuro */
            border-color: #dc3545; /* Borde rojo */
            cursor: not-allowed;
            text-decoration: none; /* Sin tachar, para mostrar las plazas restantes */
        }
        /* --- FIN DEL CAMBIO --- */


        .boton-consultar {
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 6px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 1rem;
        }
        .boton-consultar:hover:not(:disabled) { background-color: #218838; }
        .boton-consultar:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        .boton-enviar {
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 8px;
            background-color: #0056b3;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 2rem;
        }
        .boton-enviar:hover:not(:disabled) { background-color: #004494; }
        .boton-enviar:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #submitStatus, #horasStatus, #consultaStatus {
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 600;
            min-height: 1.2em;
        }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-sending { color: #555; }

        #resultado {
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            background-color: #f4f7f6;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            min-height: 2em;
            text-align: left;
            line-height: 1.6;
        }
        #resultado p { margin: 0; }
        #resultado strong { color: #0056b3; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Completa tu Cita</h1>
        
        <div class="paso">
            <label>1. ¿Cuántas personas sois? (1-8):</label>
            <div id="contenedorPersonas"></div>
        </div>
        
        <div class="paso" id="pasoDatos">
            <label>2. Introduce tus datos:</label>
            <div class="campo-texto">
                <label for="miNombre">Nombre:</label>
                <input type="text" id="miNombre" placeholder="Tu nombre completo">
            </div>
            <div class="campo-texto">
                <label for="miTelefono">Teléfono:</label>
                <input type="tel" id="miTelefono" placeholder="Ej: 600 123 456">
            </div>
            <div class="campo-texto">
                <label for="miEmail">Gmail (Email):</label>
                <input type="email" id="miEmail" placeholder="tu.correo@gmail.com">
            </div>
        </div>

        <div class="paso" id="pasoConsulta">
            <button type="button" id="checkBtn" class="boton-consultar" disabled>
                Buscar Disponibilidad
            </button>
            <div id="consultaStatus"></div>
        </div>

        <div id="calendario-container" style="display: none;">
            <div class="paso" id="pasoFecha">
                <label for="miFecha">3. Elige el día:</label>
                <input type="date" id="miFecha">
                <div id="horasStatus" class="status-sending"></div>
            </div>
            
            <div class="paso" id="pasoHora" style="display: none;">
                <label>4. Elige la hora (límite 50 pers.):</label>
                <div id="contenedorHoras"></div>
            </div>
        </div>
        
        <button type="button" id="enviarBtn" class="boton-enviar" disabled>
            Confirmar Reserva
        </button>
        
        <div id="submitStatus"></div>

        <div id="resultado">
            <p style="font-size: 1rem; color: #777; text-align: center;">Completa los primeros pasos.</p>
        </div>
    </div>

    <script>
        // --- 1. OBTENER ELEMENTOS ---
        const personasDiv = document.getElementById('contenedorPersonas');
        const nombreInput = document.getElementById('miNombre');
        const telefonoInput = document.getElementById('miTelefono');
        const emailInput = document.getElementById('miEmail');
        
        const checkBtn = document.getElementById('checkBtn');
        const consultaStatus = document.getElementById('consultaStatus');
        
        const calendarioContainer = document.getElementById('calendario-container');
        const fechaInput = document.getElementById('miFecha');
        const horasDiv = document.getElementById('contenedorHoras');
        const horasStatus = document.getElementById('horasStatus');
        const pasoHora = document.getElementById('pasoHora');
        
        const enviarBtn = document.getElementById('enviarBtn');
        const submitStatusDiv = document.getElementById('submitStatus');
        const resultadoDiv = document.getElementById('resultado');
        
        // --- 2. CONFIGURACIÓN Y URLs ---
        const n8nWebhookUrl = 'https://n8n-server.griffin-paridae.ts.net/webhook/Reserva';
        const n8nDisponibilidadUrl = 'https://n8n-server.griffin-paridae.ts.net/webhook/disponibilidad'; 
        
        // ¡Límite establecido aquí!
        const limitePersonasPorHora = 50;

        // --- 3. VARIABLES DE ESTADO ---
        let personasSeleccionadas = null;
        let nombreSeleccionado = null;
        let telefonoSeleccionado = null;
        let emailSeleccionado = null;
        let fechaSeleccionada = null;
        let horaSeleccionada = null;
        
        let disponibilidadCache = {}; 
        let diasCompletos = [];
        let todasLasHoras = [];


        // --- 4. INICIALIZACIÓN ---
        
        function getHoyFormato() {
            const hoy = new Date();
            hoy.setMinutes(hoy.getMinutes() - hoy.getTimezoneOffset());
            return hoy.toISOString().split('T')[0];
        }
        fechaInput.min = getHoyFormato();

        generarBotonesHora();
        generarBotonesPersonas();
        
        function generarBotonesHora() {
            for (let hora = 12; hora <= 23; hora++) {
                const horaStr = hora.toString().padStart(2, '0');
                const hora1 = `${horaStr}:00`;
                todasLasHoras.push(hora1);
                crearBotonHora(hora1);
                
                if (hora < 23) {
                    const hora2 = `${horaStr}:30`;
                    todasLasHoras.push(hora2);
                    crearBotonHora(hora2); 
                }
            }
        }
        function crearBotonHora(textoHora) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-hora';
            boton.textContent = textoHora;
            boton.dataset.hora = textoHora; 
            horasDiv.appendChild(boton);
        }
        function generarBotonesPersonas() {
            for (let i = 1; i <= 8; i++) { crearBotonPersona(i); }
        }
        function crearBotonPersona(numero) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-persona';
            boton.textContent = numero;
            boton.dataset.personas = numero;
            personasDiv.appendChild(boton);
        }

        // --- 5. MANEJADORES DE EVENTOS ---
        
        // PASO 1 y 2: PERSONAS Y DATOS
        personasDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('boton-persona')) {
                personasSeleccionadas = e.target.dataset.personas;
                document.querySelectorAll('.boton-persona').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                revisarPasosPrevios();
            }
        });
        nombreInput.addEventListener('input', () => {
            nombreSeleccionado = nombreInput.value.trim();
            revisarPasosPrevios();
        });
        telefonoInput.addEventListener('input', () => {
            telefonoSeleccionado = telefonoInput.value.trim();
            revisarPasosPrevios();
        });
        emailInput.addEventListener('input', () => {
            emailSeleccionado = emailInput.value.trim();
            revisarPasosPrevios();
        });

        // PASO 3 - BOTÓN DE CONSULTA
        checkBtn.addEventListener('click', consultarDisponibilidadTotal);


        // PASO 4 - FECHA (Filtro local)
        fechaInput.addEventListener('change', () => {
            fechaSeleccionada = fechaInput.value;
            horaSeleccionada = null; // Reiniciar hora si cambia el día
            filtrarHorasDisponibles(); // Filtra usando la caché
            actualizarResumenFinal();
        });

        // PASO 5: HORA
        horasDiv.addEventListener('click', (e) => {
            // Solo se puede hacer clic si NO está deshabilitado
            if (e.target.classList.contains('boton-hora') && !e.target.disabled) {
                horaSeleccionada = e.target.dataset.hora;
                document.querySelectorAll('.boton-hora').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                actualizarResumenFinal();
            }
        });
        
        // PASO 6: ENVIAR RESERVA
        enviarBtn.addEventListener('click', enviarDatos);

        
        // --- 6. FUNCIONES PRINCIPALES ---

        // Revisa los pasos 1 y 2 para activar el botón "Buscar Disponibilidad"
        function revisarPasosPrevios() {
            const datosCompletos = personasSeleccionadas && nombreSeleccionado && telefonoSeleccionado && emailSeleccionado;
            checkBtn.disabled = !datosCompletos;
            actualizarResumenFinal();
        }

        // Llama a n8n (GET) y recibe la lista de TODAS las reservas agrupadas
        async function consultarDisponibilidadTotal() {
            
            consultaStatus.textContent = "Buscando disponibilidad...";
            consultaStatus.className = 'status-sending';
            checkBtn.disabled = true;
            calendarioContainer.style.display = 'none';
            pasoHora.style.display = 'none';

            // [Código NUEVO para index.html]
            const url = `${n8nDisponibilidadUrl}?personas=${personasSeleccionadas}`; 
            const plazasDeseadas = parseInt(personasSeleccionadas);

            try {
                const response = await fetch(url, { method: 'GET' }); 
                if (!response.ok) { throw new Error('El servidor de n8n no respondió bien.'); }
                
                // n8n devuelve: {"2025-10-25": {"12:00": 20, "12:30": 50}, ...}
                disponibilidadCache = await response.json(); 

                // Procesamos la caché para encontrar días 100% completos
                diasCompletos = [];
                Object.keys(disponibilidadCache).forEach(dia => {
                    const horasOcupadas = disponibilidadCache[dia];
                    let horasLlenas = 0;
                    
                    todasLasHoras.forEach(hora => {
                        const reservasActuales = horasOcupadas[hora] || 0;
                        if ((reservasActuales + plazasDeseadas) > limitePersonasPorHora) {
                            horasLlenas++;
                        }
                    });
                    
                    if (horasLlenas === todasLasHoras.length) {
                        diasCompletos.push(dia);
                    }
                });
                
                // Éxito: Mostramos el calendario
                consultaStatus.textContent = "¡Disponibilidad cargada!";
                consultaStatus.className = 'status-success';
                calendarioContainer.style.display = 'block';
                
                horasStatus.textContent = `Selecciona un día. Días completos detectados: ${diasCompletos.length}`;

            } catch (error) {
                console.error("Error al consultar disponibilidad:", error);
                consultaStatus.textContent = "Error de red al consultar disponibilidad. Revisa la consola (F12).";
                consultaStatus.className = 'status-error';
            } finally {
                checkBtn.disabled = false; // Reactivamos el botón
            }
        }
        
        // --- CAMBIO: Lógica de filtrado de horas actualizada ---
        function filtrarHorasDisponibles() {
            const plazasDeseadas = parseInt(personasSeleccionadas);
            const disponibilidadDia = disponibilidadCache[fechaSeleccionada] || {}; 
            let horasDisponibles = 0;

            // Comprobar si el día entero está en nuestra lista de "completos"
            if (diasCompletos.includes(fechaSeleccionada)) {
                horasStatus.textContent = `Lo sentimos, el día ${fechaSeleccionada} está completo. Por favor, selecciona otro día.`;
                horasStatus.className = 'status-error';
                pasoHora.style.display = 'none'; // Ocultar botones de hora
                return;
            }

            // Si el día no está 100% completo, mostramos las horas
            pasoHora.style.display = 'block';
            
            document.querySelectorAll('.boton-hora').forEach(boton => {
                const hora = boton.dataset.hora;
                const reservasActuales = disponibilidadDia[hora] || 0;
                const plazasRestantes = limitePersonasPorHora - reservasActuales;
                
                // Limpiar estados de la filtración anterior
                boton.classList.remove('selected');
                boton.classList.remove('no-suficiente'); // ¡Quitar clase roja!
                boton.disabled = false; // Habilitarlo por defecto

                
                if (plazasRestantes <= 0) {
                    // CASO 1: 100% Lleno (0 o menos plazas)
                    // (Esto incluye el caso de 51/50)
                    boton.disabled = true;
                    boton.textContent = `${hora} (Completo)`;

                } else if (plazasDeseadas > plazasRestantes) {
                    // CASO 2: No hay sitio para TU GRUPO (ej. pides 2, queda 1)
                    boton.disabled = true; // Deshabilitado (no se puede clicar)
                    boton.classList.add('no-suficiente'); // ¡Se pone rojo!
                    boton.textContent = `${hora} (${plazasRestantes} disp.)`; // Muestra la plaza restante
                
                } else {
                    // CASO 3: Hay sitio
                    boton.disabled = false;
                    boton.textContent = `${hora} (${plazasRestantes} disp.)`;
                    horasDisponibles++;
                }
            });

            // Actualizar mensaje de estado
            if (horasDisponibles > 0) {
                horasStatus.textContent = `Mostrando ${horasDisponibles} franjas horarias disponibles:`;
                horasStatus.className = 'status-success';
            } else {
                horasStatus.textContent = `Lo sentimos, no hay plazas para ${plazasDeseadas} personas en este día.`;
                horasStatus.className = 'status-error';
            }
        }
        
        // Actualiza el resumen y el botón de envío final
        function actualizarResumenFinal() {
            const datosCompletos = personasSeleccionadas && nombreSeleccionado && telefonoSeleccionado && emailSeleccionado;
            const reservaCompleta = datosCompletos && fechaSeleccionada && horaSeleccionada;

            if (!reservaCompleta) {
                if (!datosCompletos) {
                    resultadoDiv.innerHTML = '<p style="font-size: 1rem; color: #777; text-align: center;">Completa los pasos 1 y 2 y pulsa "Buscar Disponibilidad".</p>';
                } else {
                     resultadoDiv.innerHTML = '<p style="font-size: 1rem; color: #777; text-align: center;">Selecciona un día y una hora disponible.</p>';
                }
                enviarBtn.disabled = true;
                return;
            }
            
            const fechaObjeto = new Date(`${fechaSeleccionada}T${horaSeleccionada}`);
            const diaSeleccionado = fechaObjeto.getDate();
            const mesSeleccionado = fechaObjeto.toLocaleString('es-ES', { month: 'long' });

            resultadoDiv.innerHTML = `
                <p><strong>Resumen de tu Cita:</strong></p>
                <p><strong>Día:</strong> ${diaSeleccionado} con ${mesSeleccionado}</p>
                <p><strong>Hora:</strong> ${horaSeleccionada}</p>
                <p><strong>Personas:</strong> ${personasSeleccionadas}</p>
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 0.5rem 0;">
                <p><strong>Nombre:</strong> ${nombreSeleccionado}</p>
                <p><strong>Teléfono:</strong> ${telefonoSeleccionado}</p>
                <p><strong>Email:</strong> ${emailSeleccionado}</p>
            `;
            
            enviarBtn.disabled = false;
        }
        
        // Función para ENVIAR la reserva (POST) - Sin cambios
        async function enviarDatos() {
            
            submitStatusDiv.textContent = 'Enviando reserva...';
            submitStatusDiv.className = 'status-sending';
            enviarBtn.disabled = true;

            const datosReserva = {
                fecha: fechaSeleccionada,
                hora: horaSeleccionada,
                personas: parseInt(personasSeleccionadas),
                nombre: nombreSeleccionado,
                telefono: telefonoSeleccionado,
                email: emailSeleccionado,
                fechaEnvioISO: new Date().toISOString()
            };

            try {
                const response = await fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosReserva)
                });

                if (response.ok) {
                    submitStatusDiv.textContent = '¡Reserva confirmada con éxito!';
                    submitStatusDiv.className = 'status-success';
                    calendarioContainer.style.display = 'none';
                    checkBtn.style.display = 'none';
                } else {
                    // Esto manejará el error de "plazas recién llenadas"
                    const errorData = await response.json();
                    submitStatusDiv.textContent = `Error: ${errorData.message || 'No se pudo procesar la reserva.'}`;
                    submitStatusDiv.className = 'status-error';
                    enviarBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error de red:', error);
                submitStatusDiv.textContent = 'Error de red. Revisa tu conexión.';
                submitStatusDiv.className = 'status-error';
                enviarBtn.disabled = false;
            }
        }

    </script>

</body>
</html>