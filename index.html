<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Cita</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            place-items: center;
            min-height: 100vh;
            padding: 2rem 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 550px;
            width: 90%;
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }
        
        /* Estilos para los pasos */
        .paso {
            text-align: left;
            margin-top: 1.5rem;
        }
        .paso > label {
            font-weight: bold;
            font-size: 1.2rem;
            display: block;
            margin-bottom: 0.75rem;
            color: #333;
        }
        
        /* Estilos para inputs */
        input[type="date"],
        input[type="text"],
        input[type="tel"],
        input[type="email"] {
            font-size: 1.1rem;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="date"] { cursor: pointer; }

        .campo-texto { margin-bottom: 1rem; }
        .campo-texto label {
            font-weight: 600;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
            color: #555;
        }

        /* Estilos de botones de selección (Hora y Personas) */
        #contenedorHoras,
        #contenedorPersonas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .boton-hora,
        .boton-persona {
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 0.25rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .boton-hora:hover,
        .boton-persona:hover {
            background-color: #eee;
            border-color: #ccc;
        }
        .boton-hora.selected,
        .boton-persona.selected {
            background-color: #0056b3;
            color: white;
            border-color: #004494;
        }
        
        /* Estilo del Botón de Envío */
        .boton-enviar {
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 8px;
            background-color: #0056b3;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 2rem;
        }
        
        .boton-enviar:hover:not(:disabled) {
            background-color: #004494;
        }
        
        /* Estilo cuando está desactivado */
        .boton-enviar:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        /* Estilo del Feedback de Envío */
        #submitStatus {
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 600;
            min-height: 1.2em;
        }
        .status-success { color: #28a745; } /* Verde */
        .status-error { color: #dc3545; } /* Rojo */
        .status-sending { color: #555; } /* Gris */


        /* Estilos del Resultado (Resumen) */
        #resultado {
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            background-color: #f4f7f6;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            min-height: 2em;
            text-align: left;
            line-height: 1.6;
        }
        #resultado p { margin: 0; }
        #resultado strong { color: #0056b3; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Completa tu Cita</h1>
        
        <div class="paso">
            <label for="miFecha">1. Elige el día:</label>
            <input type="date" id="miFecha">
        </div>
        
        <div class="paso">
            <label>2. Elige la hora:</label>
            <div id="contenedorHoras"></div>
        </div>
        
        <div class="paso">
            <label>3. ¿Cuántas personas sois? (1-8):</label>
            <div id="contenedorPersonas"></div>
        </div>

        <div class="paso" id="pasoDatos">
            <label>4. Introduce tus datos:</label>
            <div class="campo-texto">
                <label for="miNombre">Nombre:</label>
                <input type="text" id="miNombre" placeholder="Tu nombre completo">
            </div>
            <div class="campo-texto">
                <label for="miTelefono">Teléfono:</label>
                <input type="tel" id="miTelefono" placeholder="Ej: 600 123 456">
            </div>
            <div class="campo-texto">
                <label for="miEmail">Gmail (Email):</label>
                <input type="email" id="miEmail" placeholder="tu.correo@gmail.com">
            </div>
        </div>
        
        <button type="button" id="enviarBtn" class="boton-enviar" disabled>
            Confirmar Reserva
        </button>
        
        <div id="submitStatus"></div>

        <div id="resultado">
            <p style="font-size: 1rem; color: #777; text-align: center;">Completa todos los campos.</p>
        </div>
    </div>

    <script>
        // --- 1. OBTENER ELEMENTOS ---
        const fechaInput = document.getElementById('miFecha');
        const horasDiv = document.getElementById('contenedorHoras');
        const personasDiv = document.getElementById('contenedorPersonas');
        const nombreInput = document.getElementById('miNombre');
        const telefonoInput = document.getElementById('miTelefono');
        const emailInput = document.getElementById('miEmail');
        const resultadoDiv = document.getElementById('resultado');
        const enviarBtn = document.getElementById('enviarBtn');
        const submitStatusDiv = document.getElementById('submitStatus');

        // --- 2. VARIABLES DE ESTADO ---
        let fechaSeleccionada = null;
        let horaSeleccionada = null;
        let personasSeleccionadas = null;
        let nombreSeleccionado = null;
        let telefonoSeleccionado = null;
        let emailSeleccionado = null;

        // --- 3. CONFIGURACIÓN INICIAL ---
        
        // --- ¡CAMBIO REALIZADO! ---
        // Aquí está tu URL de n8n
        const n8nWebhookUrl = 'https://n8n-server.griffin-paridae.ts.net/webhook-test/Reserva';
        
        // Bloquear días pasados
        function getHoyFormato() {
            const hoy = new Date();
            hoy.setMinutes(hoy.getMinutes() - hoy.getTimezoneOffset());
            return hoy.toISOString().split('T')[0];
        }
        fechaInput.min = getHoyFormato();

        // Generar botones de hora
        function generarBotonesHora() {
            for (let hora = 12; hora <= 23; hora++) {
                const horaStr = hora.toString().padStart(2, '0');
                crearBotonHora(`${horaStr}:00`);
                if (hora < 23) { crearBotonHora(`${horaStr}:30`); }
            }
        }
        function crearBotonHora(textoHora) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-hora';
            boton.textContent = textoHora;
            boton.dataset.hora = textoHora; 
            horasDiv.appendChild(boton);
        }
        generarBotonesHora();
        
        // Generar botones de personas
        function generarBotonesPersonas() {
            for (let i = 1; i <= 8; i++) { crearBotonPersona(i); }
        }
        function crearBotonPersona(numero) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-persona';
            boton.textContent = numero;
            boton.dataset.personas = numero;
            personasDiv.appendChild(boton);
        }
        generarBotonesPersonas();

        // --- 4. MANEJADORES DE EVENTOS ---
        
        // Todos los eventos 'change' e 'input' llaman a actualizarResultado()
        fechaInput.addEventListener('change', () => {
            fechaSeleccionada = fechaInput.value;
            actualizarResultado();
        });
        horasDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('boton-hora')) {
                horaSeleccionada = e.target.dataset.hora;
                document.querySelectorAll('.boton-hora').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                actualizarResultado();
            }
        });
        personasDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('boton-persona')) {
                personasSeleccionadas = e.target.dataset.personas;
                document.querySelectorAll('.boton-persona').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                actualizarResultado();
            }
        });
        nombreInput.addEventListener('input', () => {
            nombreSeleccionado = nombreInput.value.trim();
            actualizarResultado();
        });
        telefonoInput.addEventListener('input', () => {
            telefonoSeleccionado = telefonoInput.value.trim();
            actualizarResultado();
        });
        emailInput.addEventListener('input', () => {
            emailSeleccionado = emailInput.value.trim();
            actualizarResultado();
        });
        
        // Evento para el botón de ENVIAR
        enviarBtn.addEventListener('click', enviarDatos);

        // --- 5. FUNCIONES ---
        
        // Esta función ahora también activa/desactiva el botón de envío
        function actualizarResultado() {
            // Comprobar que TODOS los campos estén rellenos
            const todosRellenos = fechaSeleccionada && horaSeleccionada && personasSeleccionadas && nombreSeleccionado && telefonoSeleccionado && emailSeleccionado;

            if (!todosRellenos) {
                resultadoDiv.innerHTML = '<p style="font-size: 1rem; color: #777; text-align: center;">Completa todos los campos.</p>';
                enviarBtn.disabled = true; // Botón desactivado
                return;
            }
            
            // Si están rellenos, creamos el resumen
            const fechaObjeto = new Date(`${fechaSeleccionada}T${horaSeleccionada}`);
            const diaSeleccionado = fechaObjeto.getDate();
            const mesSeleccionado = fechaObjeto.toLocaleString('es-ES', { month: 'long' });

            resultadoDiv.innerHTML = `
                <p><strong>Resumen de tu Cita:</strong></p>
                <p><strong>Día:</strong> ${diaSeleccionado} con ${mesSeleccionado}</p>
                <p><strong>Hora:</strong> ${horaSeleccionada}</p>
                <p><strong>Personas:</strong> ${personasSeleccionadas}</p>
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 0.5rem 0;">
                <p><strong>Nombre:</strong> ${nombreSeleccionado}</p>
                <p><strong>Teléfono:</strong> ${telefonoSeleccionado}</p>
                <p><strong>Email:</strong> ${emailSeleccionado}</p>
            `;
            
            // Y activamos el botón
            enviarBtn.disabled = false;
        }
        
        // Función ASÍNCRONA para enviar los datos
        async function enviarDatos() {
            
            // 1. Mostrar estado y desactivar botón
            submitStatusDiv.textContent = 'Enviando reserva...';
            submitStatusDiv.className = 'status-sending';
            enviarBtn.disabled = true;

            // 2. Crear el objeto de datos (el "payload") que recibirá n8n
            const datosReserva = {
                fecha: fechaSeleccionada,
                hora: horaSeleccionada,
                personas: parseInt(personasSeleccionadas), // Lo enviamos como número
                nombre: nombreSeleccionado,
                telefono: telefonoSeleccionado,
                email: emailSeleccionado,
                fechaEnvioISO: new Date().toISOString()
            };

            // 3. Usar 'fetch' para enviar los datos
            try {
                const response = await fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Convertimos nuestro objeto de JS a un string JSON
                    body: JSON.stringify(datosReserva)
                });

                // 4. Comprobar la respuesta del servidor
                if (response.ok) {
                    // ¡Éxito!
                    submitStatusDiv.textContent = '¡Reserva confirmada con éxito!';
                    submitStatusDiv.className = 'status-success';
                } else {
                    // Error del servidor (n8n devolvió un error)
                    const errorData = await response.json();
                    submitStatusDiv.textContent = `Error: ${errorData.message || 'No se pudo procesar la reserva.'}`;
                    submitStatusDiv.className = 'status-error';
                    enviarBtn.disabled = false; // Reactivamos el botón para reintentar
                }
            } catch (error) {
                // Error de red (no se pudo conectar con n8n)
                console.error('Error de red:', error);
                submitStatusDiv.textContent = 'Error de red. Revisa tu conexión.';
                submitStatusDiv.className = 'status-error';
                enviarBtn.disabled = false; // Reactivamos el botón para reintentar
            }
        }

    </script>

</body>
</html>