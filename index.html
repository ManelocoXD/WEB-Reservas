<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Cita</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            place-items: center;
            min-height: 100vh;
            padding: 2rem 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 550px;
            width: 90%;
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }
        .paso {
            text-align: left;
            margin-top: 1.5rem;
        }
        .paso > label {
            font-weight: bold;
            font-size: 1.2rem;
            display: block;
            margin-bottom: 0.75rem;
            color: #333;
        }
        
        input[type="date"],
        input[type="text"],
        input[type="tel"],
        input[type="email"] {
            font-size: 1.1rem;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="date"] { cursor: pointer; }

        .campo-texto { margin-bottom: 1rem; }
        .campo-texto label {
            font-weight: 600;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 0.25rem;
            color: #555;
        }

        #contenedorHoras,
        #contenedorPersonas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .boton-hora,
        .boton-persona {
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 0.25rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .boton-hora:hover:not(:disabled),
        .boton-persona:hover {
            background-color: #eee;
            border-color: #ccc;
        }
        .boton-hora.selected,
        .boton-persona.selected {
            background-color: #0056b3;
            color: white;
            border-color: #004494;
        }
        
        /* CAMBIO: Estilo para botones desactivados */
        .boton-hora:disabled {
            background-color: #f1f1f1;
            color: #aaa;
            border-color: #eee;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .boton-enviar {
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 8px;
            background-color: #0056b3;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 2rem;
        }
        .boton-enviar:hover:not(:disabled) { background-color: #004494; }
        .boton-enviar:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        #submitStatus, #horasStatus {
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 600;
            min-height: 1.2em;
        }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-sending { color: #555; }

        #resultado {
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            background-color: #f4f7f6;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            min-height: 2em;
            text-align: left;
            line-height: 1.6;
        }
        #resultado p { margin: 0; }
        #resultado strong { color: #0056b3; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Completa tu Cita</h1>
        
        <div class="paso">
            <label>1. ¿Cuántas personas sois? (1-8):</label>
            <div id="contenedorPersonas"></div>
        </div>
        
        <div class="paso" id="pasoDatos">
            <label>2. Introduce tus datos:</label>
            <div class="campo-texto">
                <label for="miNombre">Nombre:</label>
                <input type="text" id="miNombre" placeholder="Tu nombre completo">
            </div>
            <div class="campo-texto">
                <label for="miTelefono">Teléfono:</label>
                <input type="tel" id="miTelefono" placeholder="Ej: 600 123 456">
            </div>
            <div class="campo-texto">
                <label for="miEmail">Gmail (Email):</label>
                <input type="email" id="miEmail" placeholder="tu.correo@gmail.com">
            </div>
        </div>

        <div class="paso" id="pasoFecha" style="display: none;">
            <label for="miFecha">3. Elige el día:</label>
            <input type="date" id="miFecha">
        </div>
        
        <div class="paso" id="pasoHora" style="display: none;">
            <label>4. Elige la hora (límite 50 pers.):</label>
            <div id="horasStatus" class="status-sending"></div>
            <div id="contenedorHoras"></div>
        </div>
        
        <button type="button" id="enviarBtn" class="boton-enviar" disabled>
            Confirmar Reserva
        </button>
        
        <div id="submitStatus"></div>

        <div id="resultado">
            <p style="font-size: 1rem; color: #777; text-align: center;">Completa los primeros pasos.</p>
        </div>
    </div>

    <script>
        // --- 1. OBTENER ELEMENTOS ---
        const personasDiv = document.getElementById('contenedorPersonas');
        const nombreInput = document.getElementById('miNombre');
        const telefonoInput = document.getElementById('miTelefono');
        const emailInput = document.getElementById('miEmail');
        const fechaInput = document.getElementById('miFecha');
        const horasDiv = document.getElementById('contenedorHoras');
        const horasStatus = document.getElementById('horasStatus');
        const enviarBtn = document.getElementById('enviarBtn');
        const submitStatusDiv = document.getElementById('submitStatus');
        const resultadoDiv = document.getElementById('resultado');

        // --- 2. CONFIGURACIÓN Y URLs ---
        
        // URL para POSTEAR la reserva (la que ya tenías)
        const n8nWebhookUrl = 'https://n8n-server.griffin-paridae.ts.net/webhook/Reserva';
        
        // ¡NUEVO! Pega aquí la URL de tu *NUEVO* webhook (GET)
        const n8nDisponibilidadUrl = 'PEGA_AQUI_TU_NUEVO_WEBHOOK_DE_DISPONIBILIDAD';
        
        // Límite de personas por franja horaria
        const limitePersonasPorHora = 50;

        // --- 3. VARIABLES DE ESTADO ---
        let personasSeleccionadas = null;
        let nombreSeleccionado = null;
        let telefonoSeleccionado = null;
        let emailSeleccionado = null;
        let fechaSeleccionada = null;
        let horaSeleccionada = null;

        // --- 4. INICIALIZACIÓN ---
        
        // Bloquear días pasados en el calendario
        function getHoyFormato() {
            const hoy = new Date();
            hoy.setMinutes(hoy.getMinutes() - hoy.getTimezoneOffset());
            return hoy.toISOString().split('T')[0];
        }
        fechaInput.min = getHoyFormato();

        // Generar botones de hora (se generarán todos, luego los filtraremos)
        function generarBotonesHora() {
            for (let hora = 12; hora <= 23; hora++) {
                const horaStr = hora.toString().padStart(2, '0');
                crearBotonHora(`${horaStr}:00`);
                if (hora < 23) { crearBotonHora(`${horaStr}:30`); }
            }
        }
        function crearBotonHora(textoHora) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-hora';
            boton.textContent = textoHora;
            boton.dataset.hora = textoHora; 
            horasDiv.appendChild(boton);
        }
        
        // Generar botones de personas
        function generarBotonesPersonas() {
            for (let i = 1; i <= 8; i++) { crearBotonPersona(i); }
        }
        function crearBotonPersona(numero) {
            const boton = document.createElement('button');
            boton.type = 'button';
            boton.className = 'boton-persona';
            boton.textContent = numero;
            boton.dataset.personas = numero;
            personasDiv.appendChild(boton);
        }
        
        generarBotonesHora();
        generarBotonesPersonas();

        // --- 5. MANEJADORES DE EVENTOS ---
        
        // PASO 1: PERSONAS
        personasDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('boton-persona')) {
                personasSeleccionadas = e.target.dataset.personas;
                document.querySelectorAll('.boton-persona').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                
                // CAMBIO: Mostrar el calendario (Paso 3)
                document.getElementById('pasoFecha').style.display = 'block';
                actualizarResultado();
            }
        });

        // PASO 2: DATOS
        nombreInput.addEventListener('input', () => {
            nombreSeleccionado = nombreInput.value.trim();
            actualizarResultado();
        });
        telefonoInput.addEventListener('input', () => {
            telefonoSeleccionado = telefonoInput.value.trim();
            actualizarResultado();
        });
        emailInput.addEventListener('input', () => {
            emailSeleccionado = emailInput.value.trim();
            actualizarResultado();
        });

        // PASO 3: FECHA
        fechaInput.addEventListener('change', () => {
            fechaSeleccionada = fechaInput.value;
            horaSeleccionada = null; // Reiniciar hora si cambia el día
            
            // CAMBIO: Llamar a n8n para ver la disponibilidad
            consultarDisponibilidad();
            actualizarResultado();
        });

        // PASO 4: HORA
        horasDiv.addEventListener('click', (e) => {
            // Solo permitir clic si el botón no está desactivado
            if (e.target.classList.contains('boton-hora') && !e.target.disabled) {
                horaSeleccionada = e.target.dataset.hora;
                document.querySelectorAll('.boton-hora').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                actualizarResultado();
            }
        });
        
        // PASO 5: ENVIAR
        enviarBtn.addEventListener('click', enviarDatos);

        
        // --- 6. FUNCIONES PRINCIPALES ---

        // ¡NUEVA FUNCIÓN! Consulta el webhook GET de n8n
        async function consultarDisponibilidad() {
            if (n8nDisponibilidadUrl === 'PEGA_AQUI_TU_NUEVO_WEBHOOK_DE_DISPONIBILIDAD') {
                horasStatus.textContent = "Error: URL de disponibilidad no configurada.";
                horasStatus.className = 'status-error';
                return;
            }
            
            // Mostrar "cargando" y el contenedor de horas
            document.getElementById('pasoHora').style.display = 'block';
            horasStatus.textContent = "Consultando disponibilidad...";
            horasStatus.className = 'status-sending';
            
            const url = `${n8nDisponibilidadUrl}?date=${fechaSeleccionada}`;
            const plazasDeseadas = parseInt(personasSeleccionadas);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('El servidor de n8n no respondió bien.');
                }
                
                // n8n devuelve: {"12:00": 20, "12:30": 50, ...}
                const disponibilidad = await response.json(); 
                
                let horasDisponibles = 0;
                
                // Iterar sobre todos los botones de hora y filtrarlos
                document.querySelectorAll('.boton-hora').forEach(boton => {
                    const hora = boton.dataset.hora;
                    const reservasActuales = disponibilidad[hora] || 0;
                    const plazasRestantes = limitePersonasPorHora - reservasActuales;
                    
                    boton.classList.remove('selected'); // Limpiar selección previa

                    if (plazasDeseadas > plazasRestantes) {
                        // DESACTIVAR BOTÓN
                        boton.disabled = true;
                        boton.textContent = `${hora} (Completo)`;
                    } else {
                        // ACTIVAR BOTÓN
                        boton.disabled = false;
                        boton.textContent = `${hora} (${plazasRestantes} disp.)`;
                        horasDisponibles++;
                    }
                });
                
                if (horasDisponibles > 0) {
                     horasStatus.textContent = `Mostrando ${horasDisponibles} franjas horarias disponibles:`;
                     horasStatus.className = 'status-success';
                } else {
                     horasStatus.textContent = `Lo sentimos, no hay plazas para ${plazasDeseadas} personas ese día.`;
                     horasStatus.className = 'status-error';
                }

            } catch (error) {
                console.error("Error al consultar disponibilidad:", error);
                horasStatus.textContent = "Error de red al consultar las horas.";
                horasStatus.className = 'status-error';
            }
        }
        
        // Función para actualizar el resumen y el botón de envío
        function actualizarResultado() {
            // Comprobar que TODOS los campos estén rellenos
            const todosRellenos = personasSeleccionadas && nombreSeleccionado && telefonoSeleccionado && emailSeleccionado && fechaSeleccionada && horaSeleccionada;

            if (!todosRellenos) {
                if (!personasSeleccionadas || !nombreSeleccionado || !telefonoSeleccionado || !emailSeleccionado) {
                    resultadoDiv.innerHTML = '<p style="font-size: 1rem; color: #777; text-align: center;">Completa los primeros pasos.</p>';
                } else {
                     resultadoDiv.innerHTML = '<p style="font-size: 1rem; color: #777; text-align: center;">Selecciona un día y una hora disponible.</p>';
                }
                enviarBtn.disabled = true; // Botón desactivado
                return;
            }
            
            // Si están rellenos, creamos el resumen
            const fechaObjeto = new Date(`${fechaSeleccionada}T${horaSeleccionada}`);
            const diaSeleccionado = fechaObjeto.getDate();
            const mesSeleccionado = fechaObjeto.toLocaleString('es-ES', { month: 'long' });

            resultadoDiv.innerHTML = `
                <p><strong>Resumen de tu Cita:</strong></p>
                <p><strong>Día:</strong> ${diaSeleccionado} con ${mesSeleccionado}</p>
                <p><strong>Hora:</strong> ${horaSeleccionada}</p>
                <p><strong>Personas:</strong> ${personasSeleccionadas}</p>
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 0.5rem 0;">
                <p><strong>Nombre:</strong> ${nombreSeleccionado}</p>
                <p><strong>Teléfono:</strong> ${telefonoSeleccionado}</p>
                <p><strong>Email:</strong> ${emailSeleccionado}</p>
            `;
            
            // Y activamos el botón
            enviarBtn.disabled = false;
        }
        
        // Función ASÍNCRONA para enviar los datos (POST)
        // Esta función no necesita casi cambios
        async function enviarDatos() {
            
            submitStatusDiv.textContent = 'Enviando reserva...';
            submitStatusDiv.className = 'status-sending';
            enviarBtn.disabled = true;

            const datosReserva = {
                fecha: fechaSeleccionada,
                hora: horaSeleccionada,
                personas: parseInt(personasSeleccionadas),
                nombre: nombreSeleccionado,
                telefono: telefonoSeleccionado,
                email: emailSeleccionado,
                fechaEnvioISO: new Date().toISOString()
            };

            try {
                const response = await fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosReserva)
                });

                if (response.ok) {
                    submitStatusDiv.textContent = '¡Reserva confirmada con éxito!';
                    submitStatusDiv.className = 'status-success';
                    // Opcional: Ocultar botones para evitar doble reserva
                    document.getElementById('pasoHora').style.display = 'none';
                } else {
                    const errorData = await response.json();
                    submitStatusDiv.textContent = `Error: ${errorData.message || 'No se pudo procesar la reserva.'}`;
                    submitStatusDiv.className = 'status-error';
                    enviarBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error de red:', error);
                submitStatusDiv.textContent = 'Error de red. Revisa tu conexión.';
                submitStatusDiv.className = 'status-error';
                enviarBtn.disabled = false;
            }
        }

    </script>

</body>
</html>